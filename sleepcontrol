#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

INSTALL_DIR_FILE="/usr/local/bin/.ChromeOS_PowerControl.install_dir"
if [ -f "$INSTALL_DIR_FILE" ]; then
    INSTALL_DIR=$(cat "$INSTALL_DIR_FILE")
else
    INSTALL_DIR="/usr/local/bin/ChromeOS_PowerControl"
fi
INSTALL_DIR="${INSTALL_DIR%/}"

CONFIG_FILE="$INSTALL_DIR/config.sh"
PID_FILE="$INSTALL_DIR/.sleepcontrol_pid"
RUN_FLAG="$INSTALL_DIR/.sleepcontrol_enabled"
LOG_FILE="/var/log/sleepcontrol.log"
BATTERY_STATUS_PATH="/sys/class/power_supply/BAT0/status"
BACKLIGHT_NAME=""
BRIGHTNESS_PATH=""
MAX_BRIGHTNESS_PATH=""

DEFAULT_BATTERY_DELAY=12
DEFAULT_BATTERY_BACKLIGHT=7
DEFAULT_BATTERY_DIM_DELAY=3
DEFAULT_POWER_DELAY=30
DEFAULT_POWER_BACKLIGHT=15
DEFAULT_POWER_DIM_DELAY=5
BATTERY_DELAY=
BATTERY_BACKLIGHT=
BATTERY_DIM_DELAY=
POWER_DELAY=
POWER_BACKLIGHT=
POWER_DIM_DELAY=
audio_active=0
saved_display_brightness=0

BATTERY_DELAY=$DEFAULT_BATTERY_DELAY
POWER_DELAY=$DEFAULT_POWER_DELAY
BATTERY_BACKLIGHT=$DEFAULT_BATTERY_BACKLIGHT
POWER_BACKLIGHT=$DEFAULT_POWER_BACKLIGHT
BATTERY_DIM_DELAY=$DEFAULT_BATTERY_DIM_DELAY
POWER_DIM_DELAY=$DEFAULT_POWER_DIM_DELAY

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
    validate_config
}

validate_config() {
    if [[ -z "$BATTERY_DELAY" || ! "$BATTERY_DELAY" =~ ^[0-9]+$ ]]; then
        BATTERY_DELAY=$DEFAULT_BATTERY_DELAY
    fi
    if [[ -z "$POWER_DELAY" || ! "$POWER_DELAY" =~ ^[0-9]+$ ]]; then
        POWER_DELAY=$DEFAULT_POWER_DELAY
    fi
    if [[ -z "$BATTERY_BACKLIGHT" || ! "$BATTERY_BACKLIGHT" =~ ^[0-9]+$ ]]; then
        BATTERY_BACKLIGHT=$DEFAULT_BATTERY_BACKLIGHT
    fi
    if [[ -z "$POWER_BACKLIGHT" || ! "$POWER_BACKLIGHT" =~ ^[0-9]+$ ]]; then
        POWER_BACKLIGHT=$DEFAULT_POWER_BACKLIGHT
    fi

    if [[ -z "$BATTERY_DIM_DELAY" || ! "$BATTERY_DIM_DELAY" =~ ^[0-9]+$ ]]; then
        BATTERY_DIM_DELAY=$DEFAULT_BATTERY_DIM_DELAY
    fi
    if [[ -z "$POWER_DIM_DELAY" || ! "$POWER_DIM_DELAY" =~ ^[0-9]+$ ]]; then
        POWER_DIM_DELAY=$DEFAULT_POWER_DIM_DELAY
    fi
}

save_config() {
    validate_config
    sed -i "s/^BATTERY_DELAY=.*/BATTERY_DELAY=$BATTERY_DELAY/" "$CONFIG_FILE" || echo "BATTERY_DELAY=$BATTERY_DELAY" >> "$CONFIG_FILE"
    sed -i "s/^POWER_DELAY=.*/POWER_DELAY=$POWER_DELAY/" "$CONFIG_FILE" || echo "POWER_DELAY=$POWER_DELAY" >> "$CONFIG_FILE"
    sed -i "s/^BATTERY_BACKLIGHT=.*/BATTERY_BACKLIGHT=$BATTERY_BACKLIGHT/" "$CONFIG_FILE" || echo "BATTERY_BACKLIGHT=$BATTERY_BACKLIGHT" >> "$CONFIG_FILE"
    sed -i "s/^POWER_BACKLIGHT=.*/POWER_BACKLIGHT=$POWER_BACKLIGHT/" "$CONFIG_FILE" || echo "POWER_BACKLIGHT=$POWER_BACKLIGHT" >> "$CONFIG_FILE"
    sed -i "s/^BATTERY_DIM_DELAY=.*/BATTERY_DIM_DELAY=$BATTERY_DIM_DELAY/" "$CONFIG_FILE" || echo "BATTERY_DIM_DELAY=$BATTERY_DIM_DELAY" >> "$CONFIG_FILE"
    sed -i "s/^POWER_DIM_DELAY=.*/POWER_DIM_DELAY=$POWER_DIM_DELAY/" "$CONFIG_FILE" || echo "POWER_DIM_DELAY=$POWER_DIM_DELAY" >> "$CONFIG_FILE"
}

show_help() {
        echo "${BLUE}# SleepControl Commands with examples"
        echo ""
        echo "sudo sleepcontrol                     # Show current GPU info and frequency"
        echo "sudo sleepcontrol start               # Start SleepControl"
        echo "sudo sleepcontrol stop                # Stop SleepControl"
        echo "sudo sleepcontrol battery 3 7 12      # When idle, display dims in 3m, timeout in 7m, and ChromeOS sleeps in 12m when on battery"
        echo "sudo sleepcontrol power 5 15 30       # When idle, display dims in 5m, timeout in 15m and ChromeOS sleeps in 30m when on plugged-in"
        echo "sudo sleepcontrol startup             # Copy or Remove sleepcontrol.conf at: /etc/init/"
        echo "sudo sleepcontrol help                # Help menu${RESET}"
        exit 0
            }

load_config

set_display_brightness() {
    local value=$1
    if [[ -n "$BRIGHTNESS_PATH" && -n "$MAX_BRIGHTNESS_PATH" ]]; then
        local max_brightness
        max_brightness=$(cat "$MAX_BRIGHTNESS_PATH" 2>/dev/null)
        
        if ! [[ "$value" =~ ^[0-9]+$ ]]; then
            echo "Invalid brightness value: $value" >&2
            return 1
        fi

        if (( value > max_brightness )); then
            value=$max_brightness
        fi

        echo "$value" | sudo tee "$BRIGHTNESS_PATH" > /dev/null
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Set display brightness to $value" >> "$LOG_FILE"
    fi
}


send_fake_activity() {
    dbus-send --system --type=method_call \
        --dest=org.chromium.PowerManager \
        /org/chromium/PowerManager \
        org.chromium.PowerManager.HandleUserActivity int32:0 int32:0
    save_sim_time
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Simulated user activity." >> "$LOG_FILE"
}

monitor_idle_activity() {
    
exec 200>"$PID_FILE.lock"
flock -n 200 || {
    echo "Another instance is running"
    exit 1
                } 
    
    echo "$BASHPID" > "$PID_FILE"
    touch "$RUN_FLAG"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - SleepControl started (PID $$)." > "$LOG_FILE"
    local active=1
    local monitor_idle=0
    local backlight_off=0
    local kb_brightness_restored=1
    local power_backlight_ts=$(date +%s)
    local battery_backlight_ts=$(date +%s)
    local fake_activity_pid=0
    local last_reload_time=0
    local saved_kb_brightness=$(sudo ectool pwmgetkblight | awk '{print $NF}')
   
    if [[ -n "$BRIGHTNESS_PATH" ]]; then
    saved_display_brightness=$(cat "$BRIGHTNESS_PATH" 2>/dev/null || echo 0)
    fi


    start_fake_activity() {
        if (( fake_activity_pid == 0 )); then
            (
                while true; do
                    sleep 120
                    send_fake_activity
                done
            ) &
            fake_activity_pid=$!
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Started fake activity loop (PID $fake_activity_pid)." >> "$LOG_FILE"
        fi
    }

    stop_fake_activity() {
        if (( fake_activity_pid != 0 )); then
            kill "$fake_activity_pid" 2>/dev/null
            wait "$fake_activity_pid" 2>/dev/null
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Stopped fake activity loop (PID $fake_activity_pid)." >> "$LOG_FILE"
            fake_activity_pid=0
        fi
    }

    tail -Fn0 /var/log/power_manager/powerd.LATEST | while read -r line; do
        now=$(date +%s)

     now=$(date +%s)
        if (( now - last_reload_time >= 30 )); then
            load_config
            last_reload_time=$now
        fi

        case "$line" in
            *"User activity stopped"*)
                monitor_idle=1
                active=0
                kb_brightness_restored=0
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting dbus-send simulation..." >> "$LOG_FILE"
                ;;

            *"User activity reported"*|*"User activity ongoing"*|*"Audio activity"*|*"Enabling wakeup for"*|*"User triggered wake"*|*"powerd_suspend returned 0"*|*"Chrome is using normal display mode"*)
                if (( monitor_idle == 1 )); then
                        echo "$(date '+%Y-%m-%d %H:%M:%S') - Pausing dbus-send simulation..." >> "$LOG_FILE"
                    fi
                    if [[ -n "$BRIGHTNESS_PATH" ]]; then
                        saved_display_brightness=$(cat "$BRIGHTNESS_PATH" 2>/dev/null || echo 0)
                        if [[ $saved_display_brightness -gt 0 ]]; then
                            echo "$saved_display_brightness" | sudo tee "$BRIGHTNESS_PATH" >/dev/null
                        fi
                    fi
                    monitor_idle=0
                    active=1
                    stop_fake_activity
                    sudo ectool backlight 1 2>/dev/null
                    sudo ectool pwmsetkblight "$saved_kb_brightness" 2>/dev/null
                    backlight_off=0
                    kb_brightness_restored=1
                    echo "$(date '+%Y-%m-%d %H:%M:%S') - Restored keyboard and display backlight due to triggered wake." >> "$LOG_FILE"
                    power_backlight_ts=$now
                    battery_backlight_ts=$now
                ;;

            *)
                ;;
        esac

        if (( monitor_idle == 1 )); then
            status=$(cat "$BATTERY_STATUS_PATH" 2>/dev/null)

           if [[ "$status" == "Discharging" ]]; then
                dim_delay=$((BATTERY_DIM_DELAY * 60))
                backlight_delay=$((BATTERY_BACKLIGHT * 60))
                last_ts=$battery_backlight_ts
                suspend_delay=$((BATTERY_DELAY * 60))
            else
                dim_delay=$((POWER_DIM_DELAY * 60))
                backlight_delay=$((POWER_BACKLIGHT * 60))
                last_ts=$power_backlight_ts
                suspend_delay=$((POWER_DELAY * 60))
            fi

            echo "$(date '+%Y-%m-%d %H:%M:%S') - dbus-send simulation active: $now $last_ts" >> "$LOG_FILE"

           if (( now - last_ts >= dim_delay && now - last_ts < backlight_delay )); then
                if [[ -n "$MAX_BRIGHTNESS_PATH" && -r "$MAX_BRIGHTNESS_PATH" ]]; then
                    local max_brightness
                    max_brightness=$(cat "$MAX_BRIGHTNESS_PATH" 2>/dev/null || echo 255)
            
                    if [[ -n "$BRIGHTNESS_PATH" ]]; then
                        saved_display_brightness=$(cat "$BRIGHTNESS_PATH" 2>/dev/null || echo 0)
                    fi

                    local dim_value
                    if [[ $saved_display_brightness -gt 0 ]]; then
                        dim_value=$((saved_display_brightness / 8))
                    else
                        dim_value=$((max_brightness / 8))
                    fi

            
                    set_display_brightness "$dim_value"
                fi
            elif (( now - last_ts >= backlight_delay )); then
                if [ "$backlight_off" -eq 0 ]; then
                    sudo ectool backlight 0 2>/dev/null
                    backlight_off=1
                    echo "$(date '+%Y-%m-%d %H:%M:%S') - Turned off backlight due to inactivity." >> "$LOG_FILE"
                fi
            fi

            if (( now - last_ts >= suspend_delay )); then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Suspending system due to inactivity." >> "$LOG_FILE"
                dbus-send --system --type=method_call \
                    --dest=org.chromium.PowerManager \
                    /org/chromium/PowerManager \
                    org.chromium.PowerManager.RequestSuspend

                sleep 2

                power_backlight_ts=$now
                battery_backlight_ts=$now
                backlight_off=0
                if (( saved_kb_brightness > 0 )); then
                    sudo ectool pwmsetkblight "$saved_kb_brightness" 2>/dev/null
                    echo "$(date '+%Y-%m-%d %H:%M:%S') - Restored keyboard brightness to $saved_kb_brightness after suspend." >> "$LOG_FILE"
                else
                    echo "$(date '+%Y-%m-%d %H:%M:%S') - Skipped restoring brightness, saved value is zero." >> "$LOG_FILE"
                fi
                kb_brightness_restored=1
                sleep 1
                active=1
                sudo ectool backlight 1 2>/dev/null

                continue
            fi
        fi
    done
}


stop_monitoring() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "Stopping SleepControl (PGID: $PID)..."
            kill -- -"$PID" 2>/dev/null
            sleep 1
            kill "$PID" 2>/dev/null
            echo "${RED}Stopped SleepControl (PID $PID)${RESET}."
        fi
    fi
    rm -f "$RUN_FLAG"
    rm -f "$PID_FILE"
}


case "$1" in
    start)
        exec 200>"$PID_FILE.lock"
flock -n 200 || {
    echo "Another instance is running"
    exit 1
                }
        sudo ectool backlight 1 >/dev/null 2>&1
        stop_monitoring >/dev/null 2>&1
        if [ -f "$LOG_FILE" ] && [ "$(stat -c%s "$LOG_FILE")" -gt 32768 ]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Truncated log file (exceeded 32KB)" | tee -a "$LOG_FILE"
        fi
        setsid "$0" __monitor__ >> "$LOG_FILE" 2>&1 &
        echo "${GREEN}$(date '+%Y-%m-%d %H:%M:%S') - SleepControl started in background. Output is logged to $LOG_FILE${RESET}" | tee -a "$LOG_FILE"
        ;;
    stop)
        sudo ectool backlight 1 >/dev/null 2>&1
        stop_monitoring >/dev/null 2>&1
        ;;
    battery|power)
    MODE=$1

    if [[ $# -eq 4 ]]; then
        # 3 values: dim_delay, backlight_off_delay, sleep_delay
        DIM_VAL=$2
        BACKLIGHT_VAL=$3
        DELAY_VAL=$4

        # Validate all three values
        for v in "$DIM_VAL" "$BACKLIGHT_VAL" "$DELAY_VAL"; do
            if ! [[ "$v" =~ ^[0-9]+$ && "$v" -ge 1 && "$v" -le 9999 ]]; then
                echo "${RED}Values must be integers between 1 and 9999 minutes.${RESET}"
                exit 1
            fi
        done

        if (( DIM_VAL > BACKLIGHT_VAL )); then
            echo "${RED}Dim delay cannot be greater than backlight off delay.${RESET}"
            exit 1
        fi

        if (( BACKLIGHT_VAL > DELAY_VAL )); then
            echo "${RED}Backlight off delay cannot be greater than sleep delay.${RESET}"
            exit 1
        fi

        if [[ "$MODE" == "battery" ]]; then
            BATTERY_DIM_DELAY=$DIM_VAL
            BATTERY_BACKLIGHT=$BACKLIGHT_VAL
            BATTERY_DELAY=$DELAY_VAL
        else
            POWER_DIM_DELAY=$DIM_VAL
            POWER_BACKLIGHT=$BACKLIGHT_VAL
            POWER_DELAY=$DELAY_VAL
        fi

        save_config
        echo "${GREEN}${BOLD}${MODE^}${RESET}${GREEN} dim delay set to ${DIM_VAL} min, display off delay set to ${BACKLIGHT_VAL} min, sleep delay set to ${DELAY_VAL} min.${RESET}"

    elif [[ $# -eq 3 ]]; then
        # 2 values: backlight_off_delay, sleep_delay
        BACKLIGHT_VAL=$2
        DELAY_VAL=$3

        if ! [[ "$BACKLIGHT_VAL" =~ ^[0-9]+$ && "$DELAY_VAL" =~ ^[0-9]+$ ]]; then
            echo "${RED}Invalid values. Usage: sleepcontrol $MODE <backlight_off_delay> <sleep_delay>${RESET}"
            exit 1
        fi

        if (( BACKLIGHT_VAL < 1 || BACKLIGHT_VAL > 9999 || DELAY_VAL < 1 || DELAY_VAL > 9999 )); then
            echo "${RED}Values must be integers between 1 and 9999 minutes.${RESET}"
            exit 1
        fi

        if (( BACKLIGHT_VAL > DELAY_VAL )); then
            echo "${RED}Backlight timeout cannot be greater than sleep delay.${RESET}"
            exit 1
        fi

        if [[ "$MODE" == "battery" ]]; then
            BATTERY_BACKLIGHT=$BACKLIGHT_VAL
            BATTERY_DELAY=$DELAY_VAL
        else
            POWER_BACKLIGHT=$BACKLIGHT_VAL
            POWER_DELAY=$DELAY_VAL
        fi

        save_config
        echo "${GREEN}${BOLD}${MODE^}${RESET}${GREEN} Display timeout set to ${BOLD}${BACKLIGHT_VAL} min${RESET}${GREEN}, Sleep set to ${BOLD}${DELAY_VAL} min.${RESET}"

    elif [[ $# -eq 2 ]]; then
        # 1 value: sleep_delay only (deprecated? or for backward compatibility)
        VAL=$2

        if ! [[ "$VAL" =~ ^[0-9]+$ && "$VAL" -ge 1 && "$VAL" -le 9999 ]]; then
            echo "${RED}Invalid value. Must be an integer between 1 and 9999.${RESET}"
            exit 1
        fi

        if [[ "$MODE" == "battery" ]]; then
            BATTERY_DELAY=$VAL
        else
            POWER_DELAY=$VAL
        fi

        save_config
        echo "${GREEN}${BOLD}${MODE^}${RESET}${GREEN} sleep delay set to ${BOLD}${VAL} minutes.${RESET}"

    else
        # No parameters - show current config
        load_config
        if [[ "$MODE" == "battery" ]]; then
            echo "Battery: Dim delay = ${BATTERY_DIM_DELAY:-N/A} min, Display timeout = ${BATTERY_BACKLIGHT:-N/A} min, Sleep = ${BATTERY_DELAY:-N/A} min"
        else
            echo "Power: Dim delay = ${POWER_DIM_DELAY:-N/A} min, Display timeout = ${POWER_BACKLIGHT:-N/A} min, Sleep = ${POWER_DELAY:-N/A} min"
        fi
    fi
    ;;

        startup)
        CONF_SOURCE="$INSTALL_DIR/sleepcontrol.conf"
        CONF_TARGET="/etc/init/sleepcontrol.conf"

        read -p "Do you want SleepControl to startup automatically? (y/n): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            if [ -f "$CONF_SOURCE" ]; then
                echo "Copying sleepcontrol.conf to /etc/init/..."
                sudo cp "$CONF_SOURCE" "$CONF_TARGET"
                echo "${GREEN}sleepcontrol.conf copied.${RESET}"
            else
                echo "${RED}sleepcontrol.conf not found at $CONF_SOURCE${RESET}"
            fi
        else
            echo "SleepControl will not startup automatically."
            sudo rm -f /etc/init/sleepcontrol.conf
        fi
        ;;
        status|"")
        load_config
        if [ -f "$RUN_FLAG" ]; then
            PID=$(cat "$PID_FILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "${GREEN}SleepControl Status: ENABLED (PID $PID)${RESET}"
            else
                echo "${YELLOW}SleepControl Status: RUN FLAG PRESENT, but process not running${RESET}"
            fi
            echo ""
            echo "Battery = Dim: $((BATTERY_DIM_DELAY)) min -> Timeout: $((BATTERY_BACKLIGHT)) min -> Sleep: $((BATTERY_DELAY)) min"
            echo "Power = Dim: $((POWER_DIM_DELAY)) min -> Timeout: $((POWER_BACKLIGHT)) min -> Sleep: $((POWER_DELAY)) min"
            echo ""
        else
            echo "${RED}SleepControl Status: STOPPED${RESET}"
        fi
        ;;
    __monitor__)
        monitor_idle_activity
        ;;
        help)
            show_help
        ;;
    *)
        show_help
        ;;
esac
